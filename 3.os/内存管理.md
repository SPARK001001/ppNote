# 重要概念

## 虚拟内存

- 概念： 是一种操作系统的内存管理技术，为每个进程提供一个似乎连续、非常大的地址空间，远超实际物理地址大小                                                       
- 作用：给每个进程提供独立的连续地址空间，称为虚拟地址哦空间。从而允许每个进程独立进行，互不干扰，简化程序编写和运行
- 工作原理：通过将虚拟地址空间映射到物理内存ram上的真实地址空间来实现。进程访问虚拟地址时，操作系统通过**分页或分段**技术将虚拟地址映射到物理地址。如果所需指令或数据**不在物理内存**，操作系统通过**页面置换算法**将不需要的页面从内存中换出，再将所需的页面从磁盘加载到内存中
- 好处：
  - 运行进程有大量地址空间，提高进程运行能力
  - 每个进程独立进行，防止了相互干扰
  - 进程之间可以共享数据和代码，节省内存使用
- 不足：页面置换的开销和虚拟地址到物理地址的映射开销。

## 分页和分段：

- 是两种不同的内存管理方式，用于实现虚拟内存
- 分页：
  - 特点：将进程的虚拟地址空间划分为固定大小的页（page）,同时将物理地址也划分为与页相同大小的的物理页帧（page frame）.通过页表将进程的虚拟页映射到物理页帧上，从而实现虚拟地址到物理地址的转换。
  - 优点: 页大小固定，易于管理和分配。允许进程拥有连续虚拟地址空间。
  - 缺点：产生内部碎片，当一个页被加载到内存中时，可能存在部分未使用的空间。
  - 应用： linux, windows采用的分页方式实现
- 分段：
  - 特点： 将进程的虚拟地址空间划分为不同大小的段（segment）,每个段可以是代码段、数据段和堆栈段。不同段大小可以不同，根据进程需要进行动态分配。
  - 优点：允许不同段大小不同，适用不同类型的数据和代码。避免产生内部碎片
  - 缺点：地址转换复杂化，需要多级段表。可能产生外部碎片，不同段的大小不一定能够充分利用内存空间。
  - 应用： 实时操作系统或特定的应用程序

## 内存分配：

- 指将进程请求的内存分配给进程，并要高效的利用内存空间，尽量避免内存碎片。
- 常见内存分配算法和策略
  - 首次适应（first fit）: 内存空闲列表中找到第一个能满足的分配。简单快速，但可能导致内存碎片
  - 最佳适应（best fit）: 从空闲列表找能满足且大小最接近的进行分配。减少内存碎片但耗时长
  - 最坏适应（worst fit）: 找能满足且大小最大的进行分配。产生较大内存碎片但某些情况可以更好利用内存空间。
  - 临近合并（buddy system）: 解决内存碎片问题的一种方法。一块内存空间被释放时，尝试将其相邻的空闲区域合并。
  - 空间分配表（free list): 维护空闲区域的链表会数组，将内存划分为不同大小的块，当进程请求内存时，从合适的块中选择一个分配。
  - 内存压缩（memory compaction）: 出现大量内存碎片时，进行内存压缩操作，将分配的内存区域向一端移动，使所有空闲区域连续排列，形成更大的连续空闲区域

## 内存保护：

- 目的是防止进程之间相互干扰和防止进程访问非法内存区域。
- 常见内存保护机制
  - 虚拟内存：允许每个进程拥有独立的虚拟地址空间，使每个进程都认为拥有整个计算机的地址空间。操作系统通过页表或段表来实现虚拟地址空间到物理地址的映射，并确保每个进程之间的虚拟地址空间是隔离的，从而防止相互干扰
  - 权限位：操作系统为每个虚拟地址指定相应的权限位，如读、写、执行等权限。确保每个进程只能访问其拥有的合法内存区域，并防止进程对其他进程的内存进行非法操作
  - 内存隔离：一个进程尝试访问其他进程的内存，操作系统会捕获并阻止该访问
  - 堆栈保护：堆和栈是进程内部数据存储的重要区域。操作系统在堆和栈的起始结束位置设置了保护标记，防止其他进程越界访问
  - 内存交换：是一种虚拟内存管理技术，当系统内存不足，将某些进程的内存页面暂时交换到磁盘上，从而释放内存空间给其他进程使用。
  - 内存检测和保护机制：现代操作系统支持硬件级别的内存检测和保护机制，在硬件层面检测和阻止非法内存访问

## 内存映射：

- 是一种将文件或设备映射到进程的虚拟地址空间的技术（映射到虚拟地址空间后，该文件或设备的内容就像进程的一部分数据一样存在于内存中），使得进程可以直接通过内存访问文件或设备，不需要通过传统的读写操作。内存映射依赖于操作系统的内存管理机制。
- 主要优势：文件映射到内存  & 共享内存
  - 简化文件和设备的访问：进程可以直接通过内存访问文件或设备，不需要频繁调用读写文件函数或设备驱动程序。
  - 提高性能：因为是直接将文件或设备内容加载到内存中，减少了磁盘io操作，从而提高访问速度和性能
  - 支持共享数据： 多个进程可以映射同一份文件到各自虚拟内存空间，从而实现数据共享，避免了数据复制的开销。应用于进程间通信（ipc）
- 实现： 可以通过系统调用实现，在unix/linux系统中可以使用 mmap()系统调用来进行内存映射。
- 注意：
  - 注意对共享数据的的同步和一致性问题，避免数据竞争和不一致性。需使用同步机制（如信号量、互斥锁）来保证多个进程对共享内存的安全访问。
  - 谨慎处理大文件的映射， 避免占用过多内存资源

## 虚拟地址空间：

- 指的是每个进程在运行时能使用的地址范围，是进程独立的
- 逻辑地址和物理地址转换过程：
  - 当进程访问虚拟地址时，CPU会将虚拟地址传递给操作系统。
  
  - 操作系统使用虚拟地址中的高位部分（通常是虚拟页号）来索引分页表，找到对应的页表项。
  - 从页表项中读取物理页号，即找到虚拟页号对应的物理页号。
  -  将物理页号与虚拟地址的低位部分（通常是页内偏移）组合得到物理地址。
  - 将物理地址返回给CPU，CPU使用物理地址访问物理内存。

## 分页表和页表项：

- 分页表 和页表项是用来管理虚拟地址和物理地址之间映射关系的数据结构
- 分页表：

  - 是存储页表项的数据结构，通常是数组或哈希表。每个进程都有自己的分页表，用来管理自己的虚拟地址空间。其大小由操作系统预先分配，根据页表项数量决定
- 页表项：
- 是分页表中的每个元素，用来存储虚拟页号和物理页号的映射关系，以及其他一些控制信息。包含
  - 虚拟页号
    - 物理页号
    - 控制位：设置和管理页的访问权限，读写、执行权限等
    - 其他辅助信息：缓存位，有效位等
## 页面置换算法：

- 当物理内存不足时，用于决定哪些物理页面需要被置换出去，为新页面腾出空间。
- 常见页面置换算法：
  - LRU(最近最久未使用)：最久未被访问的页面被置换出去。维护一个访问时间的数据结构，链表或哈希表
  - FIFO(先进先出)： 维护队列记录页面调入顺序。性能较差，无法区分页面被访问的频率，导致热门页面被置换
  - Clock算法：维护一个类似时钟数据结构。每个页面被调入时标记为未访问，需要进行页面置换时，从当前位置开始扫描页面，遇到未访问的置换出去。已访问的标记为未访问，继续扫描。比lru实现相对简单，比fifo能更有效的保留热数据

## 内存管理单元（MMU）:

- 是计算机处理器中的一种硬件组件，负责虚拟地址到物理地址的转换和内存访问控制，实现虚拟内存管理和内存保护。

## 内存管理中的并发控制：

- 锁（locks）: 最基本的并发控制机制，可以确保同一时间只能有一个任务能够访问被保护的共享数据。锁可以分为互斥锁和读写锁，用于实现不同的并发控制策略
- 信号量（semaphores）: 允许多个任务同时访问资源，但可以限制任务数量。信号量可以分为二进制信号量和计数信号量，用于互斥访问和资源计数。
- 原子操作（atomic operation）:是一种特殊指令，操作不可分割，用于对共享数据进行简单的自增或自减操作。
- 读写锁： 允许多个任务同时读，但写需要互斥访问。应用于读多写少的场景，提高并发性能。

## 内存优化：

- 旨在提高系统性能和资源利用率，减少内存占用，避免内存泄漏和内存碎片等问题。
- 技巧和策略
  - 内存池：提前分配较大内存空间，划分为固定大小的内存块，避免频繁进行内存分配和释放，减少内存碎片
  - 避免内存泄漏：及时释放不再使用的内存
  - 使用栈内存：相比堆内存，栈内存的分配和释放更高效。
  - 减少内存拷贝：内存拷贝是比较耗时的操作，通过使用指针或引用来减少不必要的拷贝
  - 使用内存映射：对大文件或大数据集，将文件映射到虚拟内存，避免将整个文件读入内存，减少内存占用。
  - 压缩数据：对大量重复数据，考虑使用压缩算法减少内存占用
  - 数据结构优化：如使用位图来表示稀疏数据可以节省大量空间
  - 内存对齐：减少内存碎片和提高内存访问
  - 缓存优化：减少对内存频繁访问，提高系统性能
  - 释放不需要的资源：关闭文件、释放数据库连接等